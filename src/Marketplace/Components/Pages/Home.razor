@page "/"
@using Marketplace.Components.Layout
@using static Marketplace.Components.Layout.MainLayout
@using MudBlazor
@using System.Globalization
@inject IDialogService DialogService

<div class="dashboard-container">
    @switch (_currentStep)
    {
        case 1:
            @* The main dashboard view *@
            <PromotionCarousel Offers="_offers.Take(3).ToList()" OnOfferClick="HandleOrderClick" />
            <CategoryCarousel Categories="_categories" OnCategoryClick="HandleCategoryClick" OnShowAllClick="@(() => SetStep(5))" />
            <div class="services-section">
                <div class="d-flex justify-space-between align-center mb-2">
                    <MudText Typo="Typo.h6" Style="font-weight: 700;">Navrhované služby</MudText>
                    <MudIconButton OnClick="ShowComingSoon" Style="color:#0081EC" Icon="@Icons.Material.Filled.FilterList" />
                </div>
                <MudStack Spacing="2">
                    @foreach (var offer in _offers.Skip(3).Take(8))
                    {
                        <OfferCard Offer="offer" OnOrderClick="HandleOrderClick" />
                    }
                </MudStack>
            </div>
            break;

        case 2:
            @* The detailed view for the selected category *@
            <ServiceListView Offers="_offers"
                             Category="_selectedCategory"
                             OnBackClick="@(() => SetStep(1))"
                             OnOrderClick="@(HandleOrderClick)" />
            break;

        case 3:
            @* The Order page, which now knows which step to go back to *@
            <Order Offer="_selectedOffer" PreviousStep="_previousStep" OnBackClick="HandleOnBackClick" OnConfirmOrder="HandleConfirmOrder" />
            break;
            
        case 4:
            @* The new order confirmation screen *@
            <OrderConfirmation OnViewOrder="ShowComingSoon" OnClose="@(() => SetStep(1))" />
            break;
            
        case 5:
            @* The new screen showing all categories *@
            <AllCategoriesView Categories="_categories" OnCategoryClick="HandleCategoryClick" OnBackClick="@(() => SetStep(1))" />
            break;
    }
</div>


@code {
    private int _currentStep = 1;
    private int _previousStep;
    private List<Category> _categories = new();
    private Category _selectedCategory;
    private Offer _selectedOffer;

    [CascadingParameter] private List<Offer> _offers { get; set; } = new();

    public class Category
    {
        public string Name { get; set; }
        public string IconSvg { get; set; }
        public string BackgroundColor { get; set; }
        public string[] Filters { get; set; }
    }

    protected override void OnInitialized()
    {
        LoadCategories();
    }

    private void HandleCategoryClick(Category category)
    {
        _selectedCategory = category;
        SetStep(2);
    }

    private void HandleOrderClick(Offer offer)
    {
        _selectedOffer = offer;
        _previousStep = _currentStep; // Store the step we are coming from
        SetStep(3);
    }
    
    private void HandleConfirmOrder()
    {
        SetStep(4);
    }

    // This method now receives the step to go back to from the Order page
    private void HandleOnBackClick(int step)
    {
        SetStep(step);
    }

    private void SetStep(int step)
    {
        _currentStep = step;
        StateHasChanged();
    }

    private async Task ShowComingSoon()
    {
        await DialogService.ShowAsync<ComingSoonDialog>("Funkcia v Príprave");
    }


    private void LoadCategories() => _categories = new List<Category>
    {
        new() { Name = "Auto", 
            Filters = new [] { "Výmena pneumatík", "Servis", "Čistenie", "Technická kontrola", "Prenájom", "Kúpa", "Tuning", "Poistenie", "Doplnky", "Financovanie" },
            BackgroundColor = "#1C3C37", 
            IconSvg = @"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M19 17H21C21.6 17 22 16.6 22 16V13C22 12.1 21.3 11.3 20.5 11.1C18.7 10.6 16 10 16 10C16 10 14.7 8.6 13.8 7.7C13.3 7.3 12.7 7 12 7H5C4.4 7 3.9 7.4 3.6 7.9L2.2 10.8C2.06758 11.1862 2 11.5917 2 12V16C2 16.6 2.4 17 3 17H5' stroke='#70D0BC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M7 19C8.10457 19 9 18.1046 9 17C9 15.8954 8.10457 15 7 15C5.89543 15 5 15.8954 5 17C5 18.1046 5.89543 19 7 19Z' stroke='#70D0BC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M9 17H15' stroke='#70D0BC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M17 19C18.1046 19 19 18.1046 19 17C19 15.8954 18.1046 15 17 15C15.8954 15 15 15.8954 15 17C15 18.1046 15.8954 19 17 19Z' stroke='#70D0BC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>" 
        },
        new() { Name = "Bývanie",
            Filters = new [] { "Upratovanie", "Záhradnícke služby", "Nábytok", "Elektronika", "Kúpa nehnuteľností", "Prenájom nehnuteľností", "Sťahovanie", "Poistenie", "Doplnky" },
            BackgroundColor = "#4B3F18", 
            IconSvg = @"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M18 20V12C18 11.7348 17.8946 11.4804 17.7071 11.2929C17.5196 11.1054 17.2652 11 17 11H13C12.7348 11 12.4804 11.1054 12.2929 11.2929C12.1054 11.4804 12 11.7348 12 12V20' stroke='#D5BF68' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M6 10C6 9.70905 6.06304 9.42173 6.18561 9.15772C6.30819 8.89371 6.48734 8.65975 6.70938 8.472L12.7094 3.473C13.0695 3.16792 13.5266 3.00049 13.9994 3.00049C14.4721 3.00049 14.9292 3.16792 15.2894 3.473L21.2894 8.472C21.5114 8.65975 21.6906 8.89371 21.8131 9.15772C21.9357 9.42173 21.9987 9.70905 21.9987 10V19C21.9987 19.5305 21.788 20.0392 21.4129 20.4142C21.0379 20.7893 20.5293 21 19.9987 21H8.00125C7.47071 21 6.96207 20.7893 6.58705 20.4142C6.21203 20.0392 6.00125 19.5305 6.00125 19V10' stroke='#D5BF68' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>" 
        },
        new() { Name = "Remeselníci",
            Filters = new [] { "Elektroinštalácie", "Vodoinštalácie", "Stolárske práce", "Solárne panely", "Maliarske práce", "Okná a tieniaca technika", "Stavebné práce", "Vykurovanie a chladenie" },
            BackgroundColor = "#471D39", 
            IconSvg = @"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z' stroke='#B7719B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>" 
        },
        new() { Name = "Zdravie",
            Filters = new [] { "Zdravotná starostlivosť", "Duševné zdravie", "Fitness a šport", "Výživa a doplnky", "Wellness a relax", "Preventívne prehliadky", "Zdravotné poistenie", "Rehabilitácia", "Kaderníctvo", "Kozmetika", "Manikúra a pedikúra" },
            BackgroundColor = "#492D1B", 
            IconSvg = @"<svg width='22' height='20' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M18 12C19.49 10.54 21 8.79 21 6.5C21 5.04131 20.4205 3.64236 19.3891 2.61091C18.3576 1.57946 16.9587 1 15.5 1C13.74 1 12.5 1.5 11 3C9.5 1.5 8.26 1 6.5 1C5.04131 1 3.64236 1.57946 2.61091 2.61091C1.57946 3.64236 1 5.04131 1 6.5C1 8.8 2.5 10.55 4 12L11 19L18 12Z' stroke='#B37A4D' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>" 
        },
        new() { Name = "Vzdelávanie a rozvoj",
            Filters = new [] { "Školy a kurzy", "Online vzdelávanie", "Doučovanie", "Kariérne poradenstvo", "Jazykové kurzy", "Certifikácie a školenia", "Detské vzdelávanie", "Mentoring a koučing" },
            BackgroundColor = "#1C2847", 
            IconSvg = @"<svg width='22' height='20' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M11 5V19M11 5C11 3.93913 10.5786 2.92172 9.82843 2.17157C9.07828 1.42143 8.06087 1 7 1H2C1.73478 1 1.48043 1.10536 1.29289 1.29289C1.10536 1.48043 1 1.73478 1 2V15C1 15.2652 1.10536 15.5196 1.29289 15.7071C1.48043 15.8946 1.73478 16 2 16H8C8.79565 16 9.55871 16.3161 10.1213 16.8787C10.6839 17.4413 11 18.2044 11 19M11 5C11 3.93913 11.4214 2.92172 12.1716 2.17157C12.9217 1.42143 13.9391 1 15 1H20C20.2652 1 20.5196 1.10536 20.7071 1.29289C20.8946 1.48043 21 1.73478 21 2V15C21 15.2652 20.8946 15.5196 20.7071 15.7071C20.5196 15.8946 20.2652 16 20 16H14C13.2044 16 12.4413 16.3161 11.8787 16.8787C11.3161 17.4413 11 18.2044 11 19' stroke='#476EBB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>" 
        },
        new() { Name = "Administratíva",
            Filters = new [] { "Zakladanie firmy", "Účtovníctvo a dane", "Právne služby", "Programovanie", "Marketing" },
            BackgroundColor = "#450E13", 
            IconSvg = @"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z' stroke='#C30F48' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M14 2V8H20' stroke='#C30F48' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M16 13H8' stroke='#C30F48' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M16 17H8' stroke='#C30F48' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M10 9H8' stroke='#C30F48' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>"
        },
        new() { Name = "Cestovanie a voľný čas",
            Filters = new [] { "Dovolenky a pobyty", "Kultúrne podujatia", "Športové aktivity", "Hobby", "Reštaurácie a gastro", "Domáce zvieratá", "Outdoor a turistika", "Cestovné poistenie" },
            BackgroundColor = "#2D1F42",
            IconSvg = @"<svg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z' stroke='#7D5CAB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M12 22C14.7614 22 17 17.5228 17 12C17 6.47715 14.7614 2 12 2C9.23858 2 7 6.47715 7 12C7 17.5228 9.23858 22 12 22Z' stroke='#7D5CAB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M2 12H22' stroke='#7D5CAB' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>"
        }
    };
}
